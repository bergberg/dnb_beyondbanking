---
  title: "gene expr - mut"
  output: html_notebook
---
  
```{r setup}
require(tidyverse)
require(fst)
require(furrr)
```

# join gene expr and mut data

```{r paged.print=TRUE}

Lung_GeneExpression <- read_fst("../../data/intermediates/Lung_GeneExpression_normal.fst") %>% as_data_frame
Lung_Mutation <- read_fst("../../data/startset/Lung_Mutation.txt.fst") %>% as_data_frame


head(Lung_GeneExpression)
head(Lung_Mutation)


Lung_Mutation_Transposed = 
  Lung_Mutation %>%
  group_by(Sample_ID, Gene, Chr) %>% 
  summarise(count = n()) %>% 
  as_data_frame() %>% 
  gather(Sample_ID, value = count, starts_with("TCGA")) %>%
  as_data_frame %>% 
  tidyr::unite(Gene_Chr, Gene,Chr) %>%
  spread(Gene_Chr,count) %>% 
  as_data_frame

Lung_Mutation_Transposed[is.na(Lung_Mutation_Transposed)] = 0




rm(Lung_Mutation)
```



```{r}

colnames(Lung_Mutation_Transposed) = 
  c("Sample_ID" ,str_c(colnames(Lung_Mutation_Transposed[,-1]), "_mut"))


colnames(Lung_GeneExpression) = 
  c("Sample_ID" ,str_c(colnames(Lung_GeneExpression[,-1]), "_gen"))


head(Lung_Mutation_Transposed)
head(Lung_GeneExpression)

genexpr_mut <- inner_join(Lung_Mutation_Transposed, Lung_GeneExpression, by = "Sample_ID")

#variation per column
zero_var = which(apply(genexpr_mut[,-1], 2, sd)==0) + 1 
gen_zero_var = genexpr_mut[,zero_var]
genexpr_mut = genexpr_mut[,-zero_var]


head(genexpr_mut)

rm(Lung_GeneExpression)
rm(Lung_Mutation_Transposed)
```

# correlation networks

```{r}


require(sparsebn)
smpl <- genexpr_mut[,sample(2:(ncol(genexpr_mut)), 10000)]
head(smpl)


golden_lambda = 5
 
dat <- sparsebnUtils::sparsebnData(smpl, type ="continuous")
nn <- sparsebnUtils::num.samples(dat) # number of samples in the dataset / equivalent to nrow(dat$data)

mut_columns <- str_subset(tbl_vars(smpl), '_mut$')
geneexpr_columns <-str_subset(tbl_vars(smpl), '_gen$')

blacklist <- bind_rows(cross(list(a=mut_columns,b=mut_columns)),cross(list(a=geneexpr_columns,b=geneexpr_columns))) %>% as.matrix
cov_expr_mut <- sparsebn::estimate.dag(dat, blacklist=blacklist, lambdas=golden_lambda)
```

```{r}
cov_expr_mut


g = graph_from_adjacency_matrix(cov_exprmut[[1]]>0, mode = 'directed')
plot(g)

```


```{r plot non-zero coefficients}
data_frame(lambda=lambdas[-2:-1], 
           fr_nonzero = cov_exprcnv %>% map(as.vector) %>% map(`>`,0) %>% map_dbl(mean)) %>% 
  ggplot(aes(lambda,fr_nonzero)) + geom_line() + geom_smooth() + theme_minimal()


```


