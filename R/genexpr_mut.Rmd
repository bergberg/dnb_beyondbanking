---
  title: "gene expr - mut"
  output: html_notebook
---
  
```{r setup}
require(tidyverse)
require(fst)
require(furrr)
```

# join gene expr and mut data

```{r paged.print=TRUE}

Lung_GeneExpression <- read_fst("../../data/intermediates/Lung_GeneExpression_normal.fst") %>% as_data_frame
Lung_Mutation <- read_fst("../../data/startset/Lung_Mutation.txt.fst") %>% as_data_frame


head(Lung_GeneExpression)
head(Lung_Mutation)


Lung_Mutation_Transposed = 
  Lung_Mutation %>%
  group_by(Sample_ID, Gene, Chr) %>% 
  summarise(count = n()) %>% 
  as_data_frame() %>% 
  gather(Sample_ID, value = count, starts_with("TCGA")) %>%
  as_data_frame %>% 
  tidyr::unite(Gene_Chr, Gene,Chr) %>%
  spread(Gene_Chr,count) %>% 
  as_data_frame

Lung_Mutation_Transposed[is.na(Lung_Mutation_Transposed)] = 0




rm(Lung_Mutation)
```



```{r}

colnames(Lung_Mutation_Transposed) = 
  c("Sample_ID" ,str_c(colnames(Lung_Mutation_Transposed[,-1]), "_mut"))


colnames(Lung_GeneExpression) = 
  c("Sample_ID" ,str_c(colnames(Lung_GeneExpression[,-1]), "_gen"))


head(Lung_Mutation_Transposed)
head(Lung_GeneExpression)

genexpr_mut <- inner_join(Lung_Mutation_Transposed, Lung_GeneExpression, by = "Sample_ID")

head(genexpr_mut)

rm(Lung_GeneExpression)
rm(Lung_Mutation_Transposed)
```

# correlation networks

```{r}
require(sparsebn)
smpl <- genexpr_mut[,sample(2:(ncol(genexpr_mut)), 1000)]

 
dat <- sparsebnUtils::sparsebnData(smpl, type ="continuous")
nn <- sparsebnUtils::num.samples(dat) # number of samples in the dataset / equivalent to nrow(dat$data)
lambdas <- sparsebnUtils::generate.lambdas(sqrt(nn), 0.001, lambdas.length = 100, scale = "linear")




mut_columns <- str_subset(tbl_vars(smpl), 'cnv$')
geneexpr_columns <-str_subset(tbl_vars(smpl), 'geneexpr$')
whitelist <- cross_df(list(cnv=cnv_columns,geneexpr=geneexpr_columns)) %>% as.matrix
```

```{r}
cov_exprmut <- sparsebn::estimate.covariance(dat,lambdas=lambdas)
```


```{r plot non-zero coefficients}
data_frame(lambda=lambdas[-2:-1], 
           fr_nonzero = cov_exprcnv %>% map(as.vector) %>% map(`>`,0) %>% map_dbl(mean)) %>% 
  ggplot(aes(lambda,fr_nonzero)) + geom_line() + geom_smooth() + theme_minimal()


```


